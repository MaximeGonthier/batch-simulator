Nix
	curl -L https://nixos.org/nix/install | sh
	IL FAUT ABSOLUMENT SOURCE POUR UTILISER NIX: . /home/gonthier/.nix-profile/etc/profile.d/nix.sh

Pour ne pas répéter tout le build à chaque différence
	nix-env -iA cachix -f https://cachix.org/api/v1/install
	cachix use batsim
	
? utile ?
	sudo echo 1 > /proc/sys/kernel/unprivileged_userns_clone

DL d'un exemple du git de Batsim
	curl -Lo ./env-stable.nix https://framagit.org/batsim/batsim/-/raw/master/docs/tuto-first-simulation/tuto-env.nix\?inline\=fals

Lancer le shell nix
	nix-shell ./env-stable.nix

Tester la version
	batsim --version

Sortir
	Exit, Ctrl+d
	
Lancer des commandes sans passer par le shell nix en interactif
	nix-shell ./env-stable.nix --command 'robin ./instance.yaml'
Puis les résultats sont dans
	tree /tmp/expe-out

Installer batsim pour utiliser en dehors de l'environnement nix-shell
	nix-env -f https://github.com/oar-team/nur-kapack/archive/master.tar.gz -iA batsim batsched batexpe

Lancer une expe
	Dans un terminal
		batsim -p /tmp/batsim-src-stable/platforms/cluster512.xml \
			-w /tmp/batsim-src-stable/workloads/test_batsim_paper_workload_seed1.json \
			-e "/tmp/expe-out/out"
	Dans un second terminal
		batsched -v easy_bf

Pybatsim
	pip3 install pybatsim
	Lancer un sched avec pybatsim fillerSched par exemple

Pour lancer son propre algo il faut dans le fichier config préciser de prendre le dépot local et non le paquet batsched classque.


clone batsched et copier les fichier ici
lancer le shell nyx avec shell.nix
utiliser le fichier yalm

modifier meson.build pour ajout de fichiers






batsim -p /batsim-src-stable/platforms/cluster8.xml \
       -w /batsim-src-stable/workloads/test.json \
       -e "expe-out-maxime/out"

The scheduler can now be run in the second terminal to start the simulation. In this tutorial we will use the batsched decision process, which is the reference implementation of a Batsim decision process. The following command runs batsched with the EASY backfilling algorithm.

batsched -v easy_bf

Ou

Faut mettre tmp pour le fichier out car sinon il a pas les droits pour créer des dossier :/

robin generate ./test-maxime-2.yaml \
      --output-dir=/tmp/expe-out-maxime \
      --batcmd="batsim -p /home/gonthier/these_gonthier_maxime/Stage_Suede/Batsim/tmp-Yishu/batsim-src-stable/platforms/cluster8.xml -w  /home/gonthier/these_gonthier_maxime/Stage_Suede/Batsim/tmp-Yishu/batsim-src-stable/workloads/test.json -e /tmp/expe-out-maxime/out" \
      --schedcmd='batsched -v easy_bf'

Pour installer batsched il faut:
	sudo apt-get install libboost-all-dev
	sudo apt install meson
	https://stackoverflow.com/questions/24295876/cmake-cannot-find-googletest-required-library-in-ubuntu
	https://intervalset.readthedocs.io/en/latest/install.html
	https://github.com/emilk/loguru
	sudo apt install libgmp-dev
	sudo apt install rapidjson-dev
	
	Erreur sur loguru:
	gonthier@gonthier-Precision-3551:~/batsched/build$ cmake ..
-- Boost version: 1.65.1
-- Found the following Boost libraries:
--   regex
--   locale
CMake Error at /usr/share/cmake-3.10/Modules/FindPackageHandleStandardArgs.cmake:137 (message):
  Could NOT find loguru (missing: LOGURU_INCLUDE_DIR LOGURU_LIBRARIES)
Call Stack (most recent call first):
  /usr/share/cmake-3.10/Modules/FindPackageHandleStandardArgs.cmake:378 (_FPHSA_FAILURE_MESSAGE)
  cmake/Modules/Findloguru.cmake:14 (find_package_handle_standard_args)
  CMakeLists.txt:48 (find_package)


-- Configuring incomplete, errors occurred!
See also "/home/gonthier/batsched/build/CMakeFiles/CMakeOutput.log".




Pour pybatsim en fichier .yaml:
batcmd: batsim -p /home/gonthier/these_gonthier_maxime/Stage_Suede/Batsim/tmp-Yishu/batsim-src-stable/platforms/cluster8.xml -w /home/gonthier/pybatsim/pybatsim-core/tests/workloads/test_bf.json
  -e /tmp/expe-out-maxime/out
failure-timeout: 5
output-dir: /tmp/expe-out-maxime
ready-timeout: 10
schedcmd: pybatsim /home/gonthier/pybatsim/pybatsim-functional/src/pybatsim_functional/schedulers/schedEasySjfBackfill.py
#~ schedcmd: pybatsim /home/gonthier/pybatsim/pybatsim-functional/src/pybatsim_functional/schedulers/schedFiller.py
#~ schedcmd: pybatsim /home/gonthier/pybatsim/pybatsim-functional/src/pybatsim_functional/schedulers/mySched.py
#~ schedcmd: pybatsim /home/gonthier/pybatsim/pybatsim-core/src/pybatsim/schedulers/fillerSched.py
simulation-timeout: 604800
success-timeout: 3600



Compiler et tout faire depuis Nix et le .yalm directement dans nix

--events: pour les pannes, pas utile

Regarder si on peut ajouter des fichiers de dépendances dans les fichiers .json

https://batsim.readthedocs.io/en/latest/IO.html simuler temps de transferts
Implémeter la gestion du cache dans batsched pour annuler les transferts ou alors dans batsim

https://framateam.org/batsim/channels/town-square


Pour simuler la mémoire on pourrait ne pas mettre de transferts et ajouter de jobs dynamique pour simuler des transferts

Ajouter data dans .json
recup data dans le main.cpp de batsched
Ajouter son scheduler dans le main aussi et aussi dans le meson build ?

Gestion de l'orod dans batsched ? Fichier schedule.cpp. 

Faire un scheduler qui lit les data déjà

Pour ajouter un scheduler il faut modifier dans:
meson.build
main dans les include et au début dans la liste des scheduler et au niveau des if/else if pour le lancement de la fonction

Pour lancer je fais dans le dossier batsched-Maxime:
nix-shell
puis robin ./test-Maxime.yaml
nix-build nix-shell pour compiler dans nix

A quoi correspondent les valuers dans les fichiers .json ? Les profiles ?
Comment insérer le scheduler ?


Dans pybatsim core on peut définir un scheduler dans un module/classe et être une sous classe de BatsimSceduler puis package avec poetry ou setup tools et pybatsim definis en dependancance dans le .toml et définir un entrey point dans le .toml (un nom en gros comme dans le fichier d'exemple).
Puis pour lancer: poetry shell (poetry install avant)
Puis pybatsim est dedans
pybatsim randomsched
Dans une autre terminal on lance l'application comme plus haut.

APres le init il faut recupérer les infos des machines

.json:
profiles: 
Chaque job demande des ressources differentes et ont un submission time, et un profil
Le profil défini comment le jobest simulé, comme juste un délai de xsec ou les taches parallelent ou le seq ou mise en sequence de profiles donc le nb de répétitions de la tache (donc on peut simuler calcul - com - calcul - com)

Michael mercier a fais des IO
olivier richard

job dynamique : n'ont pas besoin d'exister dans le fichier .json. Option a passer à batsim. Et donc l'envoyer a faire a un worker directement depuis le code du scheduler, ca fias un job qui simule un IO en fait. Se souvenir de la mémoire en la simulant.

Envoyer une question sur le framateam.

Exemple de job qui simule des transferts : https://batsim.readthedocs.io/en/latest/IO.html et peut meme avoir une sequence chargement - calcul - ecriture quelque part	
